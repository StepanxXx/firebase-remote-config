<div class="dashboard-container">

<div class="dashboard-container">
  <!-- Main Content with Sidenav -->
  <mat-sidenav-container class="sidenav-container">
    
    <!-- Edit Parameter Sidenav -->
    <mat-sidenav #editSidenav 
                 mode="over" 
                 position="end" 
                 class="edit-sidenav"
                 [fixedInViewport]="true"
                 (backdropClick)="cancelEdit()"
                 disableClose="false">
      
      <div class="sidenav-header" *ngIf="editingParameter && editingParameterData">
        <div class="header-content">
          <div class="header-title">
            <mat-icon>edit</mat-icon>
            <div>
              <h2>Edit Parameter</h2>
              <p>{{ editingParameter }}</p>
            </div>
          </div>
          <button mat-icon-button (click)="cancelEdit()" matTooltip="Close">
            <mat-icon>close</mat-icon>
          </button>
        </div>
      </div>

      <div class="sidenav-content" *ngIf="editingParameterData">
        
        <!-- Basic Parameter Info -->
        <div class="edit-section">
          <h4><mat-icon>info</mat-icon> Basic Information</h4>
          
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Description</mat-label>
            <textarea matInput 
                      [(ngModel)]="editingParameterData.description" 
                      rows="3"
                      placeholder="Enter parameter description..."></textarea>
          </mat-form-field>
          
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Value Type</mat-label>
            <mat-select [(ngModel)]="editingParameterData.valueType">
              <mat-option value="STRING">STRING</mat-option>
              <mat-option value="BOOLEAN">BOOLEAN</mat-option>
              <mat-option value="NUMBER">NUMBER</mat-option>
              <mat-option value="JSON">JSON</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <!-- Default Value -->
        <div class="edit-section">
          <h4><mat-icon>settings</mat-icon> Default Value</h4>
          
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Default Value</mat-label>
            <textarea matInput 
                      [(ngModel)]="editingParameterData.defaultValue.value" 
                      rows="4"
                      placeholder="Enter default value..."></textarea>
          </mat-form-field>
          
          <mat-checkbox [(ngModel)]="editingParameterData.defaultValue.useInAppDefault">
            Use In-App Default
          </mat-checkbox>
        </div>

        <!-- Personalization -->
        <div class="edit-section">
          <h4><mat-icon>person</mat-icon> Personalization</h4>
          
          <mat-checkbox [checked]="!!editingParameterData.defaultValue?.personalizationValue"
                        (change)="togglePersonalization($event)">
            Enable Personalization
          </mat-checkbox>
          
          <mat-form-field appearance="outline" class="full-width" 
                          *ngIf="editingParameterData.defaultValue?.personalizationValue">
            <mat-label>Personalization ID</mat-label>
            <input matInput 
                   [(ngModel)]="editingParameterData.defaultValue.personalizationValue.personalizationId"
                   placeholder="Enter personalization ID...">
          </mat-form-field>
        </div>

        <!-- Rollout Configuration -->
        <div class="edit-section">
          <h4><mat-icon>trending_up</mat-icon> Rollout Configuration</h4>
          
          <mat-checkbox [checked]="!!editingParameterData.defaultValue?.rolloutValue"
                        (change)="toggleRollout($event)">
            Enable Rollout
          </mat-checkbox>
          
          <div *ngIf="editingParameterData.defaultValue?.rolloutValue" class="rollout-fields">
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Rollout ID</mat-label>
              <input matInput 
                     [(ngModel)]="editingParameterData.defaultValue.rolloutValue.rolloutId"
                     placeholder="Enter rollout ID...">
            </mat-form-field>
            
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Percentage</mat-label>
              <input matInput 
                     type="number" 
                     min="0" 
                     max="100"
                     [(ngModel)]="editingParameterData.defaultValue.rolloutValue.percent"
                     placeholder="0-100">
              <mat-hint>Percentage of users (0-100)</mat-hint>
            </mat-form-field>
            
            <mat-form-field appearance="outline" class="full-width">
              <mat-label>Rollout Value</mat-label>
              <textarea matInput 
                        [(ngModel)]="editingParameterData.defaultValue.rolloutValue.value" 
                        rows="3"
                        placeholder="Enter rollout value..."></textarea>
            </mat-form-field>
          </div>
        </div>

        <!-- Conditional Values -->
        <div class="conditional-values-section">
          <h4><mat-icon>rule</mat-icon> Conditional Values</h4>
          
          <div *ngIf="getConditionalValuesArray().length > 0">
            <div *ngFor="let conditionalValue of getConditionalValuesArray(); let i = index; trackBy: trackByConditionalValue" 
                 class="conditional-value-item">
              
              <div class="conditional-value-header">
                <div class="conditional-value-index">Condition {{ i + 1 }}</div>
                <button class="conditional-value-remove" 
                        (click)="removeConditionalValue(conditionalValue.key)"
                        matTooltip="Remove this conditional value">
                  <mat-icon>close</mat-icon>
                </button>
              </div>
              
              <div class="conditional-value-fields">
                <!-- Condition Name -->
                <div class="condition-name-field">
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Condition Name</mat-label>
                    <mat-select [value]="conditionalValue.key"
                                (selectionChange)="updateConditionalValueCondition(conditionalValue.key, $event.value)"
                                placeholder="Select a condition">
                      <mat-option *ngFor="let condition of availableConditions" 
                                  [value]="condition.name">
                        {{ condition.name }}
                      </mat-option>
                    </mat-select>
                  </mat-form-field>
                </div>
                
                <!-- Condition Expression Display -->
                <div class="condition-expression" *ngIf="getConditionExpression(conditionalValue.key)">
                  <h5><mat-icon>code</mat-icon> Expression</h5>
                  <div class="condition-expression-text">
                    {{ getConditionExpression(conditionalValue.key) }}
                  </div>
                </div>
                
                <!-- Conditional Value Type Selection -->
                <div class="conditional-value-type">
                  <h5><mat-icon>tune</mat-icon> Value Type</h5>
                  <mat-radio-group [value]="getConditionalValueType(conditionalValue)" 
                                   (change)="updateConditionalValueType(conditionalValue, $event.value)"
                                   class="value-type-radio">
                    <mat-radio-button value="value">Static Value</mat-radio-button>
                    <mat-radio-button value="useInAppDefault">Use In-App Default</mat-radio-button>
                    <mat-radio-button value="personalizationValue">Personalization</mat-radio-button>
                    <mat-radio-button value="rolloutValue">Rollout</mat-radio-button>
                  </mat-radio-group>
                </div>
                
                <!-- Static Value -->
                <mat-form-field appearance="outline" class="full-width" 
                                *ngIf="getConditionalValueType(conditionalValue) === 'value'">
                  <mat-label>Conditional Value</mat-label>
                  <textarea matInput 
                            [(ngModel)]="conditionalValue.value.value" 
                            rows="3"
                            placeholder="Enter value for this condition..."></textarea>
                </mat-form-field>
                
                <!-- Use In-App Default Message -->
                <div *ngIf="getConditionalValueType(conditionalValue) === 'useInAppDefault'" class="in-app-default-info">
                  <mat-icon>info</mat-icon>
                  <p>This condition will use the in-app default value instead of the Remote Config value.</p>
                </div>
                
                <!-- Personalization (if selected) -->
                <div *ngIf="getConditionalValueType(conditionalValue) === 'personalizationValue'" class="personalization-section">
                  <h5><mat-icon>person</mat-icon> Personalization</h5>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Personalization ID</mat-label>
                    <input matInput 
                           [(ngModel)]="conditionalValue.value.personalizationValue.personalizationId"
                           placeholder="Enter personalization ID...">
                  </mat-form-field>
                </div>
                
                <!-- Rollout (if selected) -->
                <div *ngIf="getConditionalValueType(conditionalValue) === 'rolloutValue'" class="rollout-section">
                  <h5><mat-icon>trending_up</mat-icon> Rollout</h5>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Rollout ID</mat-label>
                    <input matInput 
                           [(ngModel)]="conditionalValue.value.rolloutValue.rolloutId"
                           placeholder="Enter rollout ID...">
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="half-width">
                    <mat-label>Percentage</mat-label>
                    <input matInput 
                           type="number" 
                           min="0" 
                           max="100"
                           [(ngModel)]="conditionalValue.value.rolloutValue.percent"
                           placeholder="0-100">
                  </mat-form-field>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Rollout Value</mat-label>
                    <textarea matInput 
                              [(ngModel)]="conditionalValue.value.rolloutValue.value" 
                              rows="2"
                              placeholder="Enter rollout value..."></textarea>
                  </mat-form-field>
                </div>
              </div>
            </div>
          </div>
          
          <!-- Add New Conditional Value Button -->
          <button class="add-conditional-value" 
                  (click)="addConditionalValue()">
            <mat-icon>add</mat-icon>
            Add Conditional Value
          </button>
          
          <!-- Help Section -->
          <div class="conditional-values-help">
            <p>
              <mat-icon>info</mat-icon>
              Conditional values allow you to return different parameter values based on conditions. 
              Create conditions first in the Conditions tab, then reference them here.
              Each conditional value follows the RemoteConfigParameterValue schema.
            </p>
          </div>
        </div>

      </div>

      <!-- Sidenav Actions -->
      <div class="sidenav-actions">
        <button mat-raised-button color="primary" 
                (click)="saveEdit(editingParameter!)"
                class="full-width-button">
          <mat-icon>save</mat-icon>
          Save Changes
        </button>
        
        <button mat-stroked-button 
                (click)="cancelEdit()"
                class="full-width-button">
          <mat-icon>cancel</mat-icon>
          Cancel
        </button>
      </div>

    </mat-sidenav>

    <!-- Main Content -->
    <mat-sidenav-content class="main-content">
      <mat-toolbar color="primary">
        <span class="toolbar-title">{{ title }}</span>
        <span class="spacer"></span>
        
        <!-- Navigation Buttons -->
        <button mat-raised-button color="default" 
                routerLink="/versions"
                matTooltip="View version history and manage rollbacks">
          <mat-icon>history</mat-icon>
          Configuration History
        </button>
        
        <!-- Action Buttons -->
        <button mat-raised-button color="accent" 
                *ngIf="templateData" 
                (click)="saveTemplate()" 
                matTooltip="Save changes to Firebase">
          <mat-icon>save</mat-icon>
          Save Template
        </button>
        
        <button mat-icon-button [matMenuTriggerFor]="menu" matTooltip="More options">
          <mat-icon>more_vert</mat-icon>
        </button>
        
        <mat-menu #menu="matMenu">
          <!-- Navigation Options -->
          <button mat-menu-item routerLink="/versions">
            <mat-icon>history</mat-icon>
            <span>Configuration History</span>
          </button>
          <mat-divider></mat-divider>
          
          <!-- Download Options -->
          <button mat-menu-item (click)="downloadDefaults('JSON')">
            <mat-icon>download</mat-icon>
            <span>Download as JSON</span>
          </button>
          <button mat-menu-item (click)="downloadDefaults('XML')">
            <mat-icon>download</mat-icon>
            <span>Download as XML</span>
          </button>
          <button mat-menu-item (click)="downloadDefaults('PLIST')">
            <mat-icon>download</mat-icon>
            <span>Download as PLIST</span>
          </button>
          <mat-divider></mat-divider>
          <button mat-menu-item (click)="testFetchConfig()">
            <mat-icon>cloud_download</mat-icon>
            <span>Test Fetch Config</span>
          </button>
        </mat-menu>
      </mat-toolbar>
      
      <div class="content" *ngIf="!isLoading; else loadingSpinner">
    <mat-tab-group *ngIf="templateData">
      
      <!-- Parameters Tab -->
      <mat-tab label="Parameters">
        <div class="tab-content">
          <mat-card *ngFor="let param of templateData.parameters | keyvalue; trackBy: trackByParameterName" class="parameter-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon class="parameter-icon">settings</mat-icon>
                {{ param.key }}
                <mat-chip *ngIf="param.value.valueType" [color]="getValueTypeColor(param.value.valueType || '')" class="type-chip">
                  {{ param.value.valueType }}
                </mat-chip>
              </mat-card-title>
              <mat-card-subtitle>{{ param.value.description || 'No description' }}</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <!-- Default Value Display -->
              <div class="value-summary">
                <strong>Default:</strong> {{ param.value.defaultValue?.value || 'N/A' }}
                <span *ngIf="param.value.conditionalValues" class="conditional-count">
                  ({{ (param.value.conditionalValues | keyvalue).length }} conditions)
                </span>
              </div>

              <!-- Detailed Information in Expansion Panel -->
              <mat-expansion-panel class="details-expansion">
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    <mat-icon>info</mat-icon>
                    Full Details
                  </mat-panel-title>
                </mat-expansion-panel-header>
                
                <!-- Basic Information -->
                <div class="detail-section">
                  <h4><mat-icon>info</mat-icon> Basic Information</h4>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Description</mat-label>
                    <textarea matInput readonly>{{ param.value.description || 'No description provided' }}</textarea>
                  </mat-form-field>
                  
                  <mat-form-field appearance="outline" class="half-width">
                    <mat-label>Value Type</mat-label>
                    <input matInput readonly [value]="param.value.valueType || 'PARAMETER_VALUE_TYPE_UNSPECIFIED'">
                  </mat-form-field>
                </div>

                <!-- Default Value -->
                <div class="detail-section">
                  <h4><mat-icon>settings</mat-icon> Default Value</h4>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Default Value</mat-label>
                    <textarea matInput readonly>{{ param.value.defaultValue?.value || 'No default value' }}</textarea>
                  </mat-form-field>
                  
                  <mat-checkbox [checked]="param.value.defaultValue?.useInAppDefault" disabled>
                    Use In-App Default
                  </mat-checkbox>
                </div>

                <!-- Conditional Values -->
                <div class="detail-section" *ngIf="param.value.conditionalValues">
                  <h4><mat-icon>rule</mat-icon> Conditional Values</h4>
                  <mat-expansion-panel *ngFor="let condValue of param.value.conditionalValues | keyvalue" class="nested-expansion">
                    <mat-expansion-panel-header>
                      <mat-panel-title>{{ condValue.key }}</mat-panel-title>
                      <mat-panel-description>{{ condValue.value.value }}</mat-panel-description>
                    </mat-expansion-panel-header>
                    
                    <div class="conditional-details">
                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Conditional Value</mat-label>
                        <textarea matInput readonly>{{ condValue.value.value }}</textarea>
                      </mat-form-field>
                      
                      <mat-checkbox [checked]="condValue.value.useInAppDefault" disabled>
                        Use In-App Default
                      </mat-checkbox>
                      
                      <!-- Personalization Value -->
                      <div *ngIf="condValue.value.personalizationValue" class="personalization-info">
                        <h5>Personalization</h5>
                        <mat-form-field appearance="outline">
                          <mat-label>Personalization ID</mat-label>
                          <input matInput readonly [value]="condValue.value.personalizationValue.personalizationId">
                        </mat-form-field>
                      </div>
                      
                      <!-- Rollout Value -->
                      <div *ngIf="condValue.value.rolloutValue" class="rollout-info">
                        <h5>Rollout Configuration</h5>
                        <mat-form-field appearance="outline">
                          <mat-label>Rollout ID</mat-label>
                          <input matInput readonly [value]="condValue.value.rolloutValue.rolloutId || 'N/A'">
                        </mat-form-field>
                        <mat-form-field appearance="outline">
                          <mat-label>Rollout Percentage</mat-label>
                          <input matInput readonly [value]="(condValue.value.rolloutValue.percent || 0) + '%'">
                        </mat-form-field>
                        <mat-form-field appearance="outline" class="full-width">
                          <mat-label>Rollout Value</mat-label>
                          <textarea matInput readonly>{{ condValue.value.rolloutValue.value || 'N/A' }}</textarea>
                        </mat-form-field>
                      </div>
                    </div>
                  </mat-expansion-panel>
                </div>

                <!-- Personalization (for default value) -->
                <div class="detail-section" *ngIf="param.value.defaultValue?.personalizationValue">
                  <h4><mat-icon>person</mat-icon> Personalization</h4>
                  <mat-form-field appearance="outline">
                    <mat-label>Personalization ID</mat-label>
                    <input matInput readonly [value]="param.value.defaultValue?.personalizationValue?.personalizationId || 'N/A'">
                  </mat-form-field>
                </div>

                <!-- Rollout (for default value) -->
                <div class="detail-section" *ngIf="param.value.defaultValue?.rolloutValue">
                  <h4><mat-icon>trending_up</mat-icon> Rollout Configuration</h4>
                  <div class="rollout-grid">
                    <mat-form-field appearance="outline">
                      <mat-label>Rollout ID</mat-label>
                      <input matInput readonly [value]="param.value.defaultValue?.rolloutValue?.rolloutId || 'N/A'">
                    </mat-form-field>
                    <mat-form-field appearance="outline">
                      <mat-label>Percentage</mat-label>
                      <input matInput readonly [value]="(param.value.defaultValue?.rolloutValue?.percent || 0) + '%'">
                    </mat-form-field>
                  </div>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Rollout Value</mat-label>
                    <textarea matInput readonly>{{ param.value.defaultValue?.rolloutValue?.value || 'N/A' }}</textarea>
                  </mat-form-field>
                </div>
              </mat-expansion-panel>
              
            </mat-card-content>
            <mat-card-actions>
              <button mat-button color="primary" 
                      (click)="startEdit(param.key, param.value.defaultValue?.value || '')">
                <mat-icon>edit</mat-icon>
                Edit
              </button>
            </mat-card-actions>
          </mat-card>
        </div>
      </mat-tab>

      <!-- Parameter Groups Tab -->
      <mat-tab label="Parameter Groups">
        <div class="tab-content">
          <mat-card *ngFor="let group of templateData.parameterGroups | keyvalue; trackBy: trackByGroupName" class="group-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon class="group-icon">folder</mat-icon>
                {{ group.key }}
                <mat-chip class="parameter-count-chip">
                  {{ (group.value.parameters | keyvalue).length }} parameters
                </mat-chip>
              </mat-card-title>
              <mat-card-subtitle>
                {{ group.value.description || 'No description' }}
              </mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              <div class="group-parameters" *ngIf="group.value.parameters">
                <h4>Parameters in this group:</h4>
                <mat-expansion-panel *ngFor="let param of group.value.parameters | keyvalue" class="parameter-expansion">
                  <mat-expansion-panel-header>
                    <mat-panel-title>
                      <mat-icon class="parameter-icon">settings</mat-icon>
                      {{ param.key }}
                    </mat-panel-title>
                    <mat-panel-description>
                      <span class="value-preview">{{ param.value.defaultValue?.value || 'N/A' }}</span>
                      <mat-chip *ngIf="param.value?.valueType" [color]="getValueTypeColor(param.value.valueType || '')" class="type-chip">
                        {{ param.value.valueType }}
                      </mat-chip>
                    </mat-panel-description>
                  </mat-expansion-panel-header>
                  
                  <div class="parameter-details">
                    <!-- Basic Information -->
                    <div class="detail-section">
                      <h4><mat-icon>info</mat-icon> Basic Information</h4>
                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Description</mat-label>
                        <textarea matInput readonly>{{ param.value.description || 'No description provided' }}</textarea>
                      </mat-form-field>
                      
                      <mat-form-field appearance="outline" class="half-width">
                        <mat-label>Value Type</mat-label>
                        <input matInput readonly [value]="param.value.valueType || 'PARAMETER_VALUE_TYPE_UNSPECIFIED'">
                      </mat-form-field>
                    </div>

                    <!-- Default Value -->
                    <div class="detail-section">
                      <h4><mat-icon>settings</mat-icon> Default Value</h4>
                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Default Value</mat-label>
                        <textarea matInput readonly>{{ param.value.defaultValue?.value || 'No default value' }}</textarea>
                      </mat-form-field>
                      
                      <mat-checkbox [checked]="param.value.defaultValue?.useInAppDefault" disabled>
                        Use In-App Default
                      </mat-checkbox>
                    </div>

                    <!-- Conditional Values -->
                    <div class="detail-section" *ngIf="param.value?.conditionalValues">
                      <h4><mat-icon>rule</mat-icon> Conditional Values</h4>
                      <mat-expansion-panel *ngFor="let condValue of param.value?.conditionalValues | keyvalue" class="nested-expansion">
                        <mat-expansion-panel-header>
                          <mat-panel-title>{{ condValue.key }}</mat-panel-title>
                          <mat-panel-description>{{ condValue.value.value }}</mat-panel-description>
                        </mat-expansion-panel-header>
                        
                        <div class="conditional-details">
                          <mat-form-field appearance="outline" class="full-width">
                            <mat-label>Conditional Value</mat-label>
                            <textarea matInput readonly>{{ condValue.value.value }}</textarea>
                          </mat-form-field>
                          
                          <mat-checkbox [checked]="condValue.value.useInAppDefault" disabled>
                            Use In-App Default
                          </mat-checkbox>
                          
                          <!-- Personalization Value -->
                          <div *ngIf="condValue.value?.personalizationValue" class="personalization-info">
                            <h5>Personalization</h5>
                            <mat-form-field appearance="outline">
                              <mat-label>Personalization ID</mat-label>
                              <input matInput readonly [value]="condValue.value.personalizationValue?.personalizationId">
                            </mat-form-field>
                          </div>
                          
                          <!-- Rollout Value -->
                          <div *ngIf="condValue.value?.rolloutValue" class="rollout-info">
                            <h5>Rollout Configuration</h5>
                            <mat-form-field appearance="outline">
                              <mat-label>Rollout ID</mat-label>
                              <input matInput readonly [value]="condValue.value.rolloutValue?.rolloutId || 'N/A'">
                            </mat-form-field>
                            <mat-form-field appearance="outline">
                              <mat-label>Rollout Percentage</mat-label>
                              <input matInput readonly [value]="(condValue.value.rolloutValue?.percent || 0) + '%'">
                            </mat-form-field>
                            <mat-form-field appearance="outline" class="full-width">
                              <mat-label>Rollout Value</mat-label>
                              <textarea matInput readonly>{{ condValue.value.rolloutValue?.value || 'N/A' }}</textarea>
                            </mat-form-field>
                          </div>
                        </div>
                      </mat-expansion-panel>
                    </div>

                    <!-- Personalization (for default value) -->
                    <div class="detail-section" *ngIf="param.value?.defaultValue?.personalizationValue">
                      <h4><mat-icon>person</mat-icon> Personalization</h4>
                      <mat-form-field appearance="outline">
                        <mat-label>Personalization ID</mat-label>
                        <input matInput readonly [value]="param.value.defaultValue?.personalizationValue?.personalizationId || 'N/A'">
                      </mat-form-field>
                    </div>

                    <!-- Rollout (for default value) -->
                    <div class="detail-section" *ngIf="param.value?.defaultValue?.rolloutValue">
                      <h4><mat-icon>trending_up</mat-icon> Rollout Configuration</h4>
                      <div class="rollout-grid">
                        <mat-form-field appearance="outline">
                          <mat-label>Rollout ID</mat-label>
                          <input matInput readonly [value]="param.value.defaultValue?.rolloutValue?.rolloutId || 'N/A'">
                        </mat-form-field>
                        <mat-form-field appearance="outline">
                          <mat-label>Percentage</mat-label>
                          <input matInput readonly [value]="(param.value.defaultValue?.rolloutValue?.percent || 0) + '%'">
                        </mat-form-field>
                      </div>
                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Rollout Value</mat-label>
                        <textarea matInput readonly>{{ param.value.defaultValue?.rolloutValue?.value || 'N/A' }}</textarea>
                      </mat-form-field>
                    </div>
                  </div>
                </mat-expansion-panel>
              </div>
              <div class="empty-group" *ngIf="!group.value.parameters || (group.value.parameters | keyvalue).length === 0">
                <mat-icon>folder_open</mat-icon>
                <p>This group doesn't contain any parameters yet</p>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- Conditions Tab -->
      <mat-tab label="Conditions">
        <div class="tab-content">
          <mat-card *ngFor="let condition of templateData.conditions; trackBy: trackByConditionName" class="condition-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon class="condition-icon">rule</mat-icon>
                {{ condition.name }}
                <mat-chip *ngIf="condition.tagColor" [color]="getConditionColor(condition.tagColor)" class="condition-chip">
                  {{ condition.tagColor }}
                </mat-chip>
              </mat-card-title>
            </mat-card-header>
            <mat-card-content>
              <mat-form-field appearance="outline" class="full-width">
                <mat-label>Expression</mat-label>
                <textarea matInput readonly rows="3">{{ condition.expression }}</textarea>
              </mat-form-field>
              
              <div class="condition-info">
                <div class="info-item">
                  <mat-icon>label</mat-icon>
                  <span><strong>Tag Color:</strong> {{ condition.tagColor || 'Not specified' }}</span>
                </div>
                <div class="info-item">
                  <mat-icon>code</mat-icon>
                  <span><strong>Expression Type:</strong> Boolean evaluation</span>
                </div>
              </div>

              <!-- Detailed Expression Analysis -->
              <mat-expansion-panel class="expression-details">
                <mat-expansion-panel-header>
                  <mat-panel-title>
                    <mat-icon>analytics</mat-icon>
                    Expression Analysis
                  </mat-panel-title>
                </mat-expansion-panel-header>
                
                <div class="expression-breakdown">
                  <h5>Expression Breakdown:</h5>
                  <mat-form-field appearance="outline" class="full-width">
                    <mat-label>Full Expression</mat-label>
                    <textarea matInput readonly rows="4">{{ condition.expression }}</textarea>
                  </mat-form-field>
                  
                  <div class="expression-info">
                    <p><strong>Expression Length:</strong> {{ condition.expression.length || 0 }} characters</p>
                    <p><strong>Complexity:</strong> {{ getExpressionComplexity(condition.expression || '') }}</p>
                    <p><strong>Variables Used:</strong> {{ getExpressionVariables(condition.expression || '').join(', ') || 'None detected' }}</p>
                  </div>
                  
                  <div class="condition-metadata" *ngIf="condition.name">
                    <h5>Condition Metadata:</h5>
                    <mat-form-field appearance="outline">
                      <mat-label>Condition Name</mat-label>
                      <input matInput readonly [value]="condition.name">
                    </mat-form-field>
                    <mat-form-field appearance="outline">
                      <mat-label>Tag Color</mat-label>
                      <input matInput readonly [value]="condition.tagColor || 'No color specified'">
                    </mat-form-field>
                  </div>
                </div>
              </mat-expansion-panel>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- Version Info Tab -->
      <mat-tab label="Version Info">
        <div class="tab-content">
          <mat-card class="version-card">
            <mat-card-header>
              <mat-card-title>
                <mat-icon class="version-icon">history</mat-icon>
                Current Version Information
                <mat-chip [color]="getUpdateOriginColor(templateData.version?.updateOrigin)" class="version-chip">
                  {{ templateData.version?.updateOrigin || 'UNKNOWN' }}
                </mat-chip>
              </mat-card-title>
              <mat-card-subtitle>Complete version metadata and update history</mat-card-subtitle>
            </mat-card-header>
            <mat-card-content>
              
              <!-- Basic Version Info -->
              <div class="version-section">
                <h4><mat-icon>info</mat-icon> Basic Information</h4>
                <div class="version-grid">
                  <mat-form-field appearance="outline">
                    <mat-label>Version Number</mat-label>
                    <input matInput readonly [value]="templateData.version?.versionNumber || 'N/A'">
                  </mat-form-field>
                  <mat-form-field appearance="outline">
                    <mat-label>Update Origin</mat-label>
                    <input matInput readonly [value]="templateData.version?.updateOrigin || 'REMOTE_CONFIG_UPDATE_ORIGIN_UNSPECIFIED'">
                  </mat-form-field>
                  <mat-form-field appearance="outline">
                    <mat-label>Update Type</mat-label>
                    <input matInput readonly [value]="templateData.version?.updateType || 'REMOTE_CONFIG_UPDATE_TYPE_UNSPECIFIED'">
                  </mat-form-field>
                  <mat-form-field appearance="outline">
                    <mat-label>Rollback Source</mat-label>
                    <input matInput readonly [value]="templateData.version?.rollbackSource || 'N/A'">
                  </mat-form-field>
                </div>
                
                <mat-form-field appearance="outline" class="full-width">
                  <mat-label>Version Description</mat-label>
                  <textarea matInput readonly rows="2">{{ templateData.version?.description || 'No description provided' }}</textarea>
                </mat-form-field>
              </div>

              <!-- Timestamp Information -->
              <div class="version-section">
                <h4><mat-icon>schedule</mat-icon> Timing Information</h4>
                <div class="version-grid">
                  <mat-form-field appearance="outline">
                    <mat-label>Update Time</mat-label>
                    <input matInput readonly [value]="templateData.version?.updateTime | date:'medium'">
                  </mat-form-field>
                  <mat-form-field appearance="outline">
                    <mat-label>Relative Time</mat-label>
                    <input matInput readonly [value]="getRelativeTime(templateData.version?.updateTime || '')">
                  </mat-form-field>
                </div>
              </div>

              <!-- User Information -->
              <div class="version-section" *ngIf="templateData.version?.updateUser">
                <h4><mat-icon>person</mat-icon> Update User Information</h4>
                <div class="version-grid">
                  <mat-form-field appearance="outline">
                    <mat-label>User Email</mat-label>
                    <input matInput readonly [value]="templateData.version?.updateUser?.email || 'N/A'">
                  </mat-form-field>
                  <mat-form-field appearance="outline">
                    <mat-label>User Name</mat-label>
                    <input matInput readonly [value]="templateData.version?.updateUser?.name || 'N/A'">
                  </mat-form-field>
                  <mat-form-field appearance="outline">
                    <mat-label>User ID</mat-label>
                    <input matInput readonly [value]="templateData.version?.updateUser?.userId || 'N/A'">
                  </mat-form-field>
                </div>
              </div>

              <!-- Statistics -->
              <div class="version-section">
                <h4><mat-icon>analytics</mat-icon> Configuration Statistics</h4>
                <div class="stats-grid">
                  <div class="stat-item">
                    <mat-icon>settings</mat-icon>
                    <div class="stat-info">
                      <div class="stat-value">{{ getParametersCount() }}</div>
                      <div class="stat-label">Parameters</div>
                      <div class="stat-details">{{ getParametersWithConditionsCount() }} with conditions</div>
                    </div>
                  </div>
                  <div class="stat-item">
                    <mat-icon>folder</mat-icon>
                    <div class="stat-info">
                      <div class="stat-value">{{ getParameterGroupsCount() }}</div>
                      <div class="stat-label">Parameter Groups</div>
                      <div class="stat-details">{{ getTotalParametersInGroups() }} total parameters</div>
                    </div>
                  </div>
                  <div class="stat-item">
                    <mat-icon>rule</mat-icon>
                    <div class="stat-info">
                      <div class="stat-value">{{ getConditionsCount() }}</div>
                      <div class="stat-label">Conditions</div>
                      <div class="stat-details">{{ getComplexConditionsCount() }} complex</div>
                    </div>
                  </div>
                  <div class="stat-item">
                    <mat-icon>trending_up</mat-icon>
                    <div class="stat-info">
                      <div class="stat-value">{{ getRolloutCount() }}</div>
                      <div class="stat-label">Rollouts</div>
                      <div class="stat-details">{{ getPersonalizationCount() }} personalized</div>
                    </div>
                  </div>
                </div>

                <!-- Advanced Statistics -->
                <mat-expansion-panel class="advanced-stats">
                  <mat-expansion-panel-header>
                    <mat-panel-title>
                      <mat-icon>bar_chart</mat-icon>
                      Advanced Statistics
                    </mat-panel-title>
                  </mat-expansion-panel-header>
                  
                  <div class="advanced-stats-content">
                    <div class="stats-row">
                      <mat-form-field appearance="outline">
                        <mat-label>Total Conditional Values</mat-label>
                        <input matInput readonly [value]="getTotalConditionalValues()">
                      </mat-form-field>
                      <mat-form-field appearance="outline">
                        <mat-label>Parameters with Rollouts</mat-label>
                        <input matInput readonly [value]="getParametersWithRolloutsCount()">
                      </mat-form-field>
                    </div>
                    <div class="stats-row">
                      <mat-form-field appearance="outline">
                        <mat-label>Parameters with Personalization</mat-label>
                        <input matInput readonly [value]="getParametersWithPersonalizationCount()">
                      </mat-form-field>
                      <mat-form-field appearance="outline">
                        <mat-label>Average Conditions per Parameter</mat-label>
                        <input matInput readonly [value]="getAverageConditionsPerParameter()">
                      </mat-form-field>
                    </div>
                    <div class="stats-row">
                      <mat-form-field appearance="outline" class="full-width">
                        <mat-label>Most Common Value Types</mat-label>
                        <input matInput readonly [value]="getMostCommonValueTypes()">
                      </mat-form-field>
                    </div>
                  </div>
                </mat-expansion-panel>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

    </mat-tab-group>
      </div>

      <ng-template #loadingSpinner>
        <div class="loading-container">
          <mat-spinner></mat-spinner>
          <p>Loading template data...</p>
        </div>
      </ng-template>
    </mat-sidenav-content>

  </mat-sidenav-container>
</div>
